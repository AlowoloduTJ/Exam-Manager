// Prisma Schema for Exam Manager System

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  password      String   // Encrypted
  role          UserRole
  name          String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Admin specific
  adminSettings AdminSettings?
  
  // Examiner specific
  examiner      Examiner?
  
  // Student specific
  student       Student?
  
  sessions      Session[]
  faceVerificationIssues FaceVerificationIssue[]
}

enum UserRole {
  ADMIN
  EXAMINER
  STUDENT
}

model AdminSettings {
  id                    String   @id @default(cuid())
  userId                String   @unique
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Institution branding
  institutionLogo       String?  // File path or URL
  institutionName       String?
  mission               String?  // Text content
  vision                String?  // Text content
  
  // Email configurations
  viceChancellorEmail   String
  registrarEmail        String
  bursarEmail           String
  librarianEmail        String
  facultyDeanEmail      String
  headOfDeptEmail       String
  facultyExamOfficerEmail String
  deptExamOfficerEmail  String
  courseLecturerEmails  String   // JSON array
  deputyVCEmail         String
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model Faculty {
  id          String   @id @default(cuid())
  name        String   @unique
  code        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  departments Department[]
}

model Department {
  id          String   @id @default(cuid())
  name        String
  code        String
  facultyId   String
  faculty     Faculty  @relation(fields: [facultyId], references: [id], onDelete: Cascade)
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  students    Student[]
  
  @@unique([facultyId, code])
}

model Examiner {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  employeeId  String   @unique
  departmentId String?
  department  Department? @relation(fields: [departmentId], references: [id])
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  evaluations EssayEvaluation[]
}

model Student {
  id                    String   @id @default(cuid())
  userId                String   @unique
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  matricNumber          String   @unique
  passportPhoto         String   // Base64 or file path
  classAttendance       Float    @default(0)
  continuousAssessment  Float    @default(0)
  departmentId          String
  department            Department @relation(fields: [departmentId], references: [id])
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  examSessions          ExamSession[]
  essaySubmissions      EssaySubmission[]
  deviceSessions        DeviceSession[]
}

model DeviceSession {
  id            String   @id @default(cuid())
  studentId     String
  student       Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  deviceId      String   @unique // Unique device identifier
  deviceInfo    String   // JSON: browser, OS, etc.
  isActive      Boolean  @default(true)
  lastActivity  DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Subject {
  id          String   @id @default(cuid())
  name        String
  code        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  questions   Question[]
  exams       Exam[]
}

model Question {
  id            String     @id @default(cuid())
  subjectId     String
  subject       Subject    @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  questionText  String     // Encrypted
  questionType  QuestionType @default(SINGLE_CHOICE)
  options       String?    // JSON array, encrypted (null for essay/coding)
  correctAnswer String?    // JSON: can be array for multiple choice, string for fill-blank, etc.
  marks         Int        @default(1)
  imageUrl      String?    // URL to question image (for hotspot/image-based questions)
  metadata      String?    // JSON: additional data (matching pairs, ordering items, etc.)
  isActive      Boolean    @default(true)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  
  examQuestions ExamQuestion[]
}

enum QuestionType {
  SINGLE_CHOICE      // Single-answer MCQ
  MULTIPLE_CHOICE    // Multiple-answer MCQ
  TRUE_FALSE         // True/False
  BEST_ANSWER        // Best-answer (multiple correct, one best)
  FILL_BLANK         // Fill-in-the-Blank / Short Answer
  MATCHING           // Matching Questions
  HOTSPOT            // Hotspot / Image-Based Questions
  ORDERING           // Ordering / Sequencing Questions
  SIMULATION         // Simulation / Scenario-Based Questions
  ESSAY              // Essay / Long-Form Questions
  CODING             // Coding Questions
}

model Exam {
  id              String   @id @default(cuid())
  title           String
  subjectId       String
  subject         Subject   @relation(fields: [subjectId], references: [id])
  description     String?
  duration        Int       // Minutes
  startTime       DateTime
  endTime         DateTime
  isActive        Boolean   @default(true)
  allowCalculator Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  questions       ExamQuestion[]
  sessions        ExamSession[]
  essayQuestions  EssayQuestion[]
}

model ExamQuestion {
  id         String   @id @default(cuid())
  examId     String
  exam       Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  questionId String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  order      Int
  marks      Int
  
  @@unique([examId, questionId])
}

model ExamSession {
  id              String   @id @default(cuid())
  examId          String
  exam            Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  studentId       String
  student         Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  startTime       DateTime @default(now())
  endTime         DateTime?
  submittedAt     DateTime?
  isSubmitted     Boolean  @default(false)
  answers         String?   // JSON, encrypted
  score           Float?
  autoSavedData   String?   // JSON, encrypted
  warnings        Int       @default(0) // Focus/audio warnings
  isLoggedOut     Boolean   @default(false)
  logoutReason    String?
  loggedOutBy     String?   // Proctor/Admin ID who logged out the student
  loggedOutAt     DateTime? // When student was logged out
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  proctoringLogs  ProctoringLog[]
}

model ProctoringLog {
  id            String      @id @default(cuid())
  sessionId     String
  session       ExamSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  eventType     ProctoringEvent
  timestamp     DateTime    @default(now())
  details       String?     // JSON: duration, reason, etc.
  actionTaken   String?
  proctorId     String?     // ID of proctor who took action
  proctorName   String?     // Name of proctor
  infractionReason String?  // Reason for proctor action
}

enum ProctoringEvent {
  FOCUS_LOST
  FOCUS_RESTORED
  AUDIO_DETECTED
  AUDIO_WARNING
  LOGOUT
  FACE_MISMATCH
}

model EssayQuestion {
  id              String   @id @default(cuid())
  examId          String
  exam            Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  questionText    String   // Encrypted
  maxMarks        Int
  minWordCount    Int?
  maxWordCount    Int?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  submissions     EssaySubmission[]
}

model EssaySubmission {
  id              String   @id @default(cuid())
  essayQuestionId String
  essayQuestion   EssayQuestion @relation(fields: [essayQuestionId], references: [id], onDelete: Cascade)
  studentId       String
  student         Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  scannedPages    String   // JSON array of file paths/URLs
  wordCount       Int
  submittedAt     DateTime @default(now())
  status          EssayStatus @default(PENDING)
  
  evaluations     EssayEvaluation[]
}

enum EssayStatus {
  PENDING
  IN_PROGRESS
  EVALUATED
  FLAGGED
  RE_EVALUATION
}

model EssayEvaluation {
  id              String   @id @default(cuid())
  submissionId    String
  submission      EssaySubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  examinerId      String
  examiner        Examiner  @relation(fields: [examinerId], references: [id])
  pageScores      String    // JSON: {page1: score, page2: score, ...}
  totalScore       Float
  comments         String?
  evaluatedAt     DateTime @default(now())
  isFlagged       Boolean  @default(false)
  flagReason       String?
}

model Result {
  id              String   @id @default(cuid())
  examId          String
  exam            Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  studentId       String
  student         Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  objectiveScore  Float?
  essayScore       Float?
  totalScore       Float
  grade            String?
  isPublished      Boolean  @default(false)
  publishedAt      DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model FaceVerificationIssue {
  id              String   @id @default(cuid())
  studentId       String
  student         Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  matricNumber   String
  attemptedAt     DateTime @default(now())
  failureReason   String
  passportPhoto   String   // Base64 or URL
  capturedPhoto   String?  // Base64 or URL of captured photo
  attempts        Int      @default(1)
  status          FaceVerificationStatus @default(PENDING)
  approvedBy      String?  // Proctor/Admin ID
  approvedAt      DateTime?
  approvalNotes   String?
  rejectedBy      String?   // Proctor/Admin ID
  rejectedAt      DateTime?
  rejectionReason String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([studentId])
  @@index([status])
}

enum FaceVerificationStatus {
  PENDING
  APPROVED
  REJECTED
}
